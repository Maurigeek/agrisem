generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////
// ENUMS
////////////////////////////////////////////////////////////

enum Role {
  PRODUCER
  SUPPLIER
  ADMIN
}

enum ProductStatus {
  DRAFT
  ACTIVE
  BLOCKED
}

enum CartStatus {
  ACTIVE
  ORDERED
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_TRANSFER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum AlertType {
  DROUGHT
  HEAVY_RAIN
  DISEASE_RISK
}

enum AlertChannel {
  EMAIL
  SMS
  BOTH
}

////////////////////////////////////////////////////////////
// USER
////////////////////////////////////////////////////////////

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  phone              String?   @unique
  password           String
  role               Role      @default(PRODUCER)
  firstName          String?
  lastName           String?
  orgName            String?
  avatarUrl          String?
  locale             String?   @default("fr")
  refreshToken       String?
  resetToken         String?
  resetTokenExp      DateTime?
  isVerified         Boolean   @default(false)
  isSupplierVerified Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  addresses       Address[]
  products        Product[]       @relation("SupplierProducts")
  ordersBuyer     Order[]         @relation("BuyerOrders")
  ordersSupplier  Order[]         @relation("SupplierOrders")
  carts           Cart[]
  sentMessages    Message[]       @relation("UserSentMessages")
  alerts          WeatherAlert[]
  articles        Article[]
  buyerThreads    MessageThread[] @relation("BuyerThreads")
  supplierThreads MessageThread[] @relation("SupplierThreads")

  orderAddresses  OrderAddress[]  @relation("ProducerOrderAddresses")
}

////////////////////////////////////////////////////////////
// ADDRESS (Saved user addresses)
////////////////////////////////////////////////////////////

model Address {
  id        Int     @id @default(autoincrement())
  user      User    @relation(fields: [userId], references: [id])
  userId    Int

  label     String?
  country   String
  region    String?
  city      String?
  latitude  Float?
  longitude Float?
  isDefault Boolean @default(false)

  orders    Order[] // relation shippingAddressId
}

////////////////////////////////////////////////////////////
// ORDER SHIPPING ADDRESS (Address used at checkout)
////////////////////////////////////////////////////////////

model OrderAddress {
  id          Int    @id @default(autoincrement())
  producer    User   @relation("ProducerOrderAddresses", fields: [producerId], references: [id])
  producerId  Int

  label       String
  country     String
  region      String
  city        String

  orders      Order[]
}

////////////////////////////////////////////////////////////
// CATALOG
////////////////////////////////////////////////////////////

model Culture {
  id        Int       @id @default(autoincrement())
  name      String
  code      String    @unique
  varieties Variety[]
}

model Variety {
  id                 Int       @id @default(autoincrement())
  culture            Culture   @relation(fields: [cultureId], references: [id])
  cultureId          Int
  name               String
  climateSuitability Json?
  description        String?
  maturityDays       Int?
  products           Product[]
}

model Product {
  id          Int           @id @default(autoincrement())
  supplier    User          @relation("SupplierProducts", fields: [supplierId], references: [id])
  supplierId  Int

  variety     Variety?       @relation(fields: [varietyId], references: [id])
  varietyId   Int?

  title       String
  sku         String        @unique
  priceCents  Int
  currency    String
  stock       Int
  minOrderQty Int           @default(1)
  images      Json
  specs       Json?
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())

  cartItems  CartItem[]
  orderItems OrderItem[]
}

////////////////////////////////////////////////////////////
// CART
////////////////////////////////////////////////////////////

model Cart {
  id     Int        @id @default(autoincrement())
  user   User       @relation(fields: [userId], references: [id])
  userId Int
  status CartStatus @default(ACTIVE)
  items  CartItem[]
}

model CartItem {
  id        Int     @id @default(autoincrement())
  cartId    Int
  cart      Cart    @relation(fields: [cartId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  qty       Int
}

////////////////////////////////////////////////////////////
// ORDER (PRODUCER buying from SUPPLIER)
////////////////////////////////////////////////////////////

model Order {
  id                Int           @id @default(autoincrement())
  orderNumber       String        @unique

  buyer             User          @relation("BuyerOrders", fields: [buyerId], references: [id])
  buyerId           Int

  supplier          User          @relation("SupplierOrders", fields: [supplierId], references: [id])
  supplierId        Int

  totalCents        Int
  currency          String
  paymentMethod     PaymentMethod
  paymentProofUrl   String?

  status            OrderStatus   @default(PENDING)

  shippingAddress   Address?      @relation(fields: [shippingAddressId], references: [id])
  shippingAddressId Int?

  orderAddress      OrderAddress? @relation(fields: [orderAddressId], references: [id])
  orderAddressId    Int?

  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  items             OrderItem[]
}

model OrderItem {
  id         Int     @id @default(autoincrement())

  orderId    Int
  order      Order   @relation(fields: [orderId], references: [id])

  productId  Int
  product    Product @relation(fields: [productId], references: [id])

  title      String
  priceCents Int
  qty        Int
}

////////////////////////////////////////////////////////////
// MESSAGING + ALERTS + ARTICLES + AUDIT
////////////////////////////////////////////////////////////

model MessageThread {
  id            Int       @id @default(autoincrement())
  topicType     String
  topicId       Int?
  buyerId       Int
  supplierId    Int
  buyer         User      @relation("BuyerThreads", fields: [buyerId], references: [id])
  supplier      User      @relation("SupplierThreads", fields: [supplierId], references: [id])
  lastMessageAt DateTime
  messages      Message[]
  createdAt     DateTime  @default(now())
}

model Message {
  id          Int           @id @default(autoincrement())
  threadId    Int
  thread      MessageThread @relation(fields: [threadId], references: [id])
  senderId    Int
  sender      User          @relation("UserSentMessages", fields: [senderId], references: [id])
  body        String
  attachments Json?
  createdAt   DateTime      @default(now())
}

model WeatherAlert {
  id         Int          @id @default(autoincrement())
  userId     Int
  user       User         @relation(fields: [userId], references: [id])
  type       AlertType
  threshold  Json?
  channel    AlertChannel
  isActive   Boolean      @default(true)
  lastSentAt DateTime?
}

model Article {
  id          Int       @id @default(autoincrement())
  title       String
  slug        String    @unique
  bodyMd      String
  tags        String[]
  authorId    Int
  author      User      @relation(fields: [authorId], references: [id])
  publishedAt DateTime?
  status      String    @default("DRAFT")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  actorId   Int
  entity    String
  entityId  Int?
  action    String
  meta      Json?
  createdAt DateTime @default(now())
}
